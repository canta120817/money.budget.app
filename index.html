<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—ã¾ã‚‹è¦‹ãˆå®¶è¨ˆç°¿</title>
    
    <!-- ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆTailwind CSSï¼‰ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- é‡è¦: Rechartsç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‚ç…§ã™ã‚‹processå¤‰æ•°ã‚’å®šç¾© -->
    <script>
        window.process = {
            env: { NODE_ENV: 'production' }
        };
    </script>

    <!-- Reactã¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿è¨­å®š (Import Map) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "recharts": "https://esm.sh/recharts@2.12.3?external=react,react-dom",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ã‹ã™ãŸã‚ã®å¤‰æ›ãƒ„ãƒ¼ãƒ« -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <style>
        body { background-color: #f0f9f6; color: #1e293b; font-family: sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-in-up { animation: fadeIn 0.4s ease-out forwards; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ã®z-indexèª¿æ•´ */
        .z-60 { z-index: 60; }
        .hidden-input { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ -->
    <!-- data-type="module" ã¨ data-presets="react" ã‚’æŒ‡å®šã—ã¦Babelã«ESMã¨ã—ã¦å‡¦ç†ã•ã›ã‚‹ -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, TrendingUp, Landmark, CreditCard, Menu, ArrowRight, 
            Settings, CheckCircle2, PieChart, PiggyBank, Coins, 
            LayoutGrid, ArrowLeftRight, RefreshCw, AlertTriangle, ChevronRight,
            UploadCloud, FileText, Download, Plus, X, Calendar, Tag, ShoppingBag,
            Target, BarChart3, ArrowUpRight, Percent, ChevronLeft, Save, Trash2, Edit2,
            Cloud, CloudOff
        } from 'lucide-react';
        import { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            Line, ComposedChart, AreaChart, Area, Cell, Pie, PieChart as RePieChart, Legend
        } from 'recharts';
        
        // Firebase Imports
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';

        // --- Firebase Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ ---

        const PAYMENT_SOURCES = {
            DIRECT: { id: 'direct', name: 'å£åº§å¼•è½', color: 'bg-slate-100 text-slate-600', icon: 'ğŸ¦' },
            RAKUTEN: { id: 'rakuten', name: 'æ¥½å¤©ã‚«ãƒ¼ãƒ‰', color: 'bg-rose-50 text-rose-600 border-rose-100', icon: 'â“‡' },
            SMBC: { id: 'smbc', name: 'ä¸‰äº•ä½å‹', color: 'bg-emerald-50 text-emerald-700 border-emerald-100', icon: 'S' },
            ONEBANK: { id: 'onebank', name: 'ãƒ¯ãƒ³ãƒãƒ³ã‚¯', color: 'bg-blue-50 text-blue-600 border-blue-100', icon: '1' },
        };

        const INITIAL_BUDGET_CONFIG = [
            { id: 'rent', name: 'å®¶è³ƒ', amount: 120000, type: 'fixed' },
            { id: 'parent', name: 'è¦ªãƒ­ãƒ¼ãƒ³', amount: 35000, type: 'fixed' },
            { id: 'food', name: 'é£Ÿè²»', amount: 25000, type: 'variable' },
            { id: 'eatout', name: 'å¤–é£Ÿè²»', amount: 15000, type: 'variable' },
            { id: 'daily', name: 'ç”Ÿæ´»ç”¨å“', amount: 10000, type: 'variable' },
            { id: 'date', name: 'ãƒ‡ãƒ¼ãƒˆä»£', amount: 20000, type: 'variable' },
            { id: 'gas', name: 'ã‚¬ã‚½ãƒªãƒ³', amount: 20000, type: 'variable' },
            { id: 'utility', name: 'å…‰ç†±è²»', amount: 15000, type: 'fixed' },
            { id: 'water', name: 'æ°´é“ä»£', amount: 6000, type: 'fixed', oddMonthOnly: true },
            { id: 'server', name: 'ã‚µãƒ¼ãƒãƒ¼', amount: 4000, type: 'fixed' },
            { id: 'sub', name: 'ã‚µãƒ–ã‚¹ã‚¯', amount: 2000, type: 'fixed' },
        ];

        const INITIAL_SAVINGS_CONFIG = [
            { id: 'hus_cash', name: 'å¤«è²¯é‡‘', amount: 40000, type: 'cash', owner: 'husband' },
            { id: 'wife_cash', name: 'å¦»è²¯é‡‘', amount: 70000, type: 'cash', owner: 'wife' },
            { id: 'nisa', name: 'ç©ç«‹NISA', amount: 30000, type: 'invest', owner: 'husband' },
            { id: 'car', name: 'è»Šæ¤œç©ç«‹', amount: 10000, type: 'reserve', owner: 'shared' },
        ];

        // å±¥æ­´ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼ˆç©ºé…åˆ—ï¼‰
        const ASSET_HISTORY_DETAILED = [];

        // ç¾åœ¨ã®è³‡ç”£å†…è¨³åˆæœŸåŒ–ï¼ˆ0å††ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
        const CURRENT_ASSETS_DETAIL = {
            cash: { husband: 0, wife: 0, shared_surplus: 0, car_reserve: 0 },
            investment: { nisa_principal: 0, nisa_profit: 0 }
        };

        // å–å¼•å±¥æ­´åˆæœŸåŒ–ï¼ˆç©ºé…åˆ—ï¼‰
        const INITIAL_TRANSACTIONS = [];

        // --- Components ---

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const ProgressBar = ({ current, max, colorClass = "bg-teal-500" }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100));
            const isOver = current > max;
            return (
                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div className={`h-full transition-all duration-500 ${isOver ? 'bg-rose-500' : colorClass}`} style={{ width: `${isOver ? 100 : percentage}%` }} />
                </div>
            );
        };

        // ManualInputModal
        const ManualInputModal = ({ isOpen, onClose, onSave, budgetConfig, defaultDate }) => {
            const defaultDateStr = defaultDate.toISOString().slice(0, 10).replace(/-/g, '.');
            const [formData, setFormData] = useState({ date: defaultDateStr, title: '', amount: '', category: budgetConfig[0].name, source: 'DIRECT' });

            useEffect(() => { if(isOpen) setFormData(prev => ({...prev, date: defaultDateStr})); }, [isOpen, defaultDateStr]);

            if (!isOpen) return null;

            const handleSubmit = () => {
                if (!formData.title || !formData.amount) return; 
                onSave({ ...formData, amount: -Math.abs(Number(formData.amount)) });
                setFormData({ ...formData, title: '', amount: '' }); 
                onClose();
            };

            return (
                <div className="fixed inset-0 z-60 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden animate-fade-in-up">
                        <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Plus className="w-5 h-5" /> æ‰‹å…¥åŠ›ã§è¿½åŠ </h3>
                            <button onClick={onClose}><X className="w-6 h-6 text-slate-400" /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1"><Calendar className="w-3 h-3"/> æ—¥ä»˜</label>
                                <input type="text" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 font-bold text-slate-700 outline-none" placeholder="YYYY.MM.DD" />
                            </div>
                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1"><CreditCard className="w-3 h-3"/> æ”¯æ‰•ã„å…ƒ</label>
                                    <select value={formData.source} onChange={(e) => setFormData({...formData, source: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-bold text-slate-700 outline-none">
                                        {Object.values(PAYMENT_SOURCES).map(src => (<option key={src.id} value={src.id.toUpperCase()}>{src.name}</option>))}
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label className="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1"><Tag className="w-3 h-3"/> é …ç›®</label>
                                    <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-bold text-slate-700 outline-none">
                                        {budgetConfig.map(b => <option key={b.id} value={b.name}>{b.name}</option>)}
                                        <option value="ãã®ä»–">ãã®ä»–</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1">å†…å®¹</label>
                                <input type="text" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 font-bold text-slate-700 outline-none" placeholder="ä¾‹: ã‚¹ãƒ¼ãƒ‘ãƒ¼ãªã©" />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1">é‡‘é¡ (å††)</label>
                                <div className="relative">
                                    <input type="number" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 pl-4 pr-10 text-xl font-bold text-slate-800 outline-none text-right" placeholder="0" />
                                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">å††</span>
                                </div>
                            </div>
                            <button onClick={handleSubmit} className="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-700 transition-all mt-2 active:scale-95">è¿½åŠ ã™ã‚‹</button>
                        </div>
                    </div>
                </div>
            );
        };

        // View Components

        const HomeView = ({ 
            selectedDate, surplus, currentTotalExpenses, actualMonthlyIncome, 
            totalSavingsPlanned, currentTotalAssets, growthSinceStart, 
            totalCash, totalInvest, handleGoToPortfolio 
        }) => (
            <div className="space-y-6 pb-24 animate-fade-in">
                <div className="text-center py-6 bg-white rounded-b-3xl shadow-sm border-b border-slate-100 -mt-4 mx-[-16px] px-4 relative overflow-hidden">
                    <div className="relative z-10">
                        <div className="text-xs font-bold text-slate-500 mb-2 flex items-center justify-center gap-2">
                        <Landmark className="w-4 h-4 text-teal-600" /> ç·è³‡ç”£é¡ (ç¾åœ¨)
                        </div>
                        <div className="text-4xl font-extrabold text-slate-800 tracking-tight">
                        {(currentTotalAssets / 10000).toFixed(0)}<span className="text-xl">ä¸‡å††</span>
                        </div>
                        <div className="mt-3 flex justify-center gap-2">
                            <span className="text-[10px] bg-teal-50 text-teal-700 px-2 py-1 rounded-full border border-teal-100 font-bold flex items-center">
                            é–‹å§‹æ¯” +{(growthSinceStart/10000).toFixed(1)}ä¸‡å†† <TrendingUp className="w-3 h-3 ml-1"/>
                            </span>
                        </div>
                    </div>
                </div>

                <Card className="bg-slate-800 text-white p-4 relative overflow-hidden border-slate-700 mt-2">
                    <div className="relative z-10">
                        <div className="flex justify-between items-start">
                            <div>
                                <div className="text-xs text-slate-400 font-bold mb-1 flex items-center gap-2">
                                    <Calendar className="w-3 h-3" />
                                    {selectedDate.getFullYear()}å¹´{selectedDate.getMonth() + 1}æœˆã®ä½™å‰°è³‡é‡‘
                                </div>
                                <div className="text-2xl font-extrabold text-amber-400">
                                    {surplus > 0 ? '+' : ''}{surplus.toLocaleString()}<span className="text-xs text-slate-400 font-normal ml-1">å††</span>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-[10px] text-slate-400 mb-1">äºˆç®—é€²æ—</div>
                                <div className={`text-lg font-bold ${(currentTotalExpenses / (actualMonthlyIncome - totalSavingsPlanned)) > 1 ? 'text-rose-400' : 'text-teal-400'}`}>
                                    {actualMonthlyIncome - totalSavingsPlanned > 0 
                                        ? Math.round((currentTotalExpenses / (actualMonthlyIncome - totalSavingsPlanned)) * 100)
                                        : '--'}%
                                </div>
                            </div>
                        </div>
                        <div className="mt-3 pt-3 border-t border-slate-700 flex justify-between text-xs text-slate-300">
                            <span>åå…¥: {actualMonthlyIncome.toLocaleString()}</span>
                            <span>æ”¯å‡º: {currentTotalExpenses.toLocaleString()}</span>
                        </div>
                        <div className="mt-1 pt-1 border-t border-slate-700/50 flex justify-between text-xs text-slate-400">
                            <span>è²¯é‡‘ãƒ»ç©ç«‹è¨ˆ:</span>
                            <span>-{totalSavingsPlanned.toLocaleString()}</span>
                        </div>
                    </div>
                </Card>

                <Card className="p-4 cursor-pointer hover:bg-slate-50 transition-colors group" onClick={handleGoToPortfolio}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <TrendingUp className="w-4 h-4 text-teal-600" /> è³‡ç”£ã®æ¨ç§»
                        </h3>
                        <ArrowRight className="w-4 h-4 text-slate-300 group-hover:text-teal-500 transition-colors" />
                    </div>
                    <div className="h-40 w-full pointer-events-none">
                        <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={[...ASSET_HISTORY_DETAILED, { month: 'ç¾åœ¨', total: currentTotalAssets }]} margin={{ top: 5, right: 0, left: -20, bottom: 0 }}>
                            <defs>
                            <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#0d9488" stopOpacity={0.1}/>
                                <stop offset="95%" stopColor="#0d9488" stopOpacity={0}/>
                            </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                            <XAxis dataKey="month" axisLine={false} tickLine={false} tick={{fontSize: 10, fill: '#94a3b8'}} />
                            <YAxis axisLine={false} tickLine={false} tick={{fontSize: 9, fill: '#94a3b8'}} tickFormatter={(val) => `${(val/10000).toFixed(0)}`} />
                            <Area type="monotone" dataKey="total" stroke="#0d9488" strokeWidth={2} fillOpacity={1} fill="url(#colorTotal)" />
                        </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </Card>

                <div className="grid grid-cols-2 gap-3">
                    <Card className="p-4" onClick={handleGoToPortfolio}>
                        <div className="flex items-center gap-2 mb-2">
                            <div className="p-1.5 bg-teal-100 text-teal-600 rounded-full"><PiggyBank className="w-4 h-4" /></div>
                            <div className="text-xs font-bold text-slate-500">ç¾é‡‘</div>
                        </div>
                        <div className="text-lg font-bold text-slate-800">{(totalCash/10000).toFixed(0)}<span className="text-xs">ä¸‡å††</span></div>
                        <div className="text-[10px] text-slate-400">ç”Ÿæ´»é˜²è¡›è³‡é‡‘</div>
                    </Card>
                    <Card className="p-4" onClick={handleGoToPortfolio}>
                        <div className="flex items-center gap-2 mb-2">
                            <div className="p-1.5 bg-blue-100 text-blue-600 rounded-full"><TrendingUp className="w-4 h-4" /></div>
                            <div className="text-xs font-bold text-slate-500">æŠ•è³‡</div>
                        </div>
                        <div className="text-lg font-bold text-slate-800">{(totalInvest/10000).toFixed(0)}<span className="text-xs">ä¸‡å††</span></div>
                        <div className="text-[10px] text-rose-500 font-bold">+{(CURRENT_ASSETS_DETAIL.investment.nisa_profit/10000).toFixed(1)}ä¸‡å††</div>
                    </Card>
                </div>
            </div>
        );

        const ClassifyView = ({ currentMonthTransactions, selectedDate, toggleShared, budgetConfig, updateTransaction, deleteTransaction }) => {
            const grouped = {
                DIRECT: currentMonthTransactions.filter(t => t.source === 'DIRECT' && t.type !== 'income'),
                RAKUTEN: currentMonthTransactions.filter(t => t.source === 'RAKUTEN'),
                SMBC: currentMonthTransactions.filter(t => t.source === 'SMBC'),
                ONEBANK: currentMonthTransactions.filter(t => t.source === 'ONEBANK'),
            };
            return (
                <div className="space-y-4 pb-24 animate-fade-in">
                    <div className="bg-teal-50 border border-teal-100 p-3 rounded-xl flex items-start gap-3">
                        <CheckCircle2 className="w-5 h-5 text-teal-600 mt-0.5" />
                        <div><h4 className="font-bold text-teal-800 text-sm">ã‹ã‚“ãŸã‚“ä»•åˆ†ã‘ ({selectedDate.getMonth() + 1}æœˆ)</h4><p className="text-xs text-teal-700">ã‚¹ã‚¤ãƒƒãƒONã§å®¶è¨ˆã«è¨ˆä¸Šã€OFFã§é™¤å¤–ã•ã‚Œã¾ã™ã€‚<br/>æ˜ç´°åã‚„ã‚«ãƒ†ã‚´ãƒªã¯ã‚¿ãƒƒãƒ—ã§å¤‰æ›´å¯èƒ½ã§ã™ã€‚</p></div>
                    </div>
                    {Object.entries(grouped).map(([key, list]) => {
                        if (list.length === 0) return null;
                        const source = PAYMENT_SOURCES[key];
                        return (
                            <Card key={key} className="mb-4">
                                <div className="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                                    <div className="flex items-center gap-2"><span className="text-lg">{source.icon}</span><span className="font-bold text-slate-700 text-sm">{source.name}</span></div>
                                    <span className="text-xs text-slate-400">{list.length}ä»¶</span>
                                </div>
                                <div className="divide-y divide-slate-100">
                                    {list.map(tx => (
                                        <div key={tx.id} className={`p-3 flex items-center justify-between transition-colors ${!tx.isShared ? 'bg-slate-50/50 opacity-60' : ''}`}>
                                            <div className="flex-1">
                                                <div className="flex items-center gap-1 mb-1">
                                                    <input 
                                                        type="text" 
                                                        value={tx.title}
                                                        onChange={(e) => updateTransaction(tx.id, 'title', e.target.value)}
                                                        className="font-bold text-slate-800 text-sm bg-transparent border-b border-dashed border-slate-300 focus:border-teal-500 outline-none w-full mr-2"
                                                    />
                                                </div>
                                                <div className="flex items-center gap-2 mt-1.5">
                                                    <select 
                                                        value={tx.category}
                                                        onChange={(e) => updateTransaction(tx.id, 'category', e.target.value)}
                                                        className={`text-xs border rounded px-1.5 py-1 outline-none font-bold ${tx.category === 'æœªåˆ†é¡' ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}
                                                    >
                                                        <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                                                        {budgetConfig.map(b => <option key={b.id} value={b.name}>{b.name}</option>)}
                                                        <option value="å…¥é‡‘">å…¥é‡‘</option>
                                                        <option value="æŒ¯æ›¿">æŒ¯æ›¿</option>
                                                        <option value="ãã®ä»–">ãã®ä»–</option>
                                                    </select>
                                                    <span className="text-xs text-slate-400">{tx.date}</span>
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-end gap-2 ml-2">
                                                <div className={`font-bold text-sm ${tx.isShared ? 'text-slate-800' : 'text-slate-400 line-through'}`}>{Math.abs(tx.amount).toLocaleString()}</div>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => deleteTransaction(tx.id)} className="p-1.5 text-slate-300 hover:text-rose-500 hover:bg-rose-50 rounded transition-colors"><Trash2 className="w-4 h-4" /></button>
                                                    <button onClick={() => toggleShared(tx.id)} className={`w-10 h-6 rounded-full transition-colors relative ${tx.isShared ? 'bg-teal-500' : 'bg-slate-300'}`}><div className={`absolute w-4 h-4 bg-white rounded-full shadow-sm top-1 transition-all ${tx.isShared ? 'left-5' : 'left-1'}`} /></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        );
                    })}
                    {Object.values(grouped).every(list => list.length === 0) && (
                        <div className="text-center py-10 text-slate-400 text-sm">
                            ã“ã®æœˆã®æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br/>CSVã‚’å–ã‚Šè¾¼ã‚€ã‹ã€æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    )}
                </div>
            );
        };

        const AnalysisView = ({
            selectedDate, budgetConfig, isOddMonth, categoryTotals, 
            surplus, totalSavingsPlanned, actualMonthlyIncome, 
            totalCash, totalInvest, currentTotalAssets, savingsConfig
        }) => {
            const [subTab, setSubTab] = useState('portfolio'); 
            
            // è³‡ç”£æ§‹æˆãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆè¨­å®šå€¤ã«åŸºã¥ãï¼‰
            const pieData = [
                { name: 'å¤«è²¯é‡‘', value: savingsConfig.find(s => s.id === 'hus_cash')?.amount || 0, fill: '#2dd4bf' },
                { name: 'å¦»è²¯é‡‘', value: savingsConfig.find(s => s.id === 'wife_cash')?.amount || 0, fill: '#14b8a6' },
                { name: 'å…±åŒãƒ»ä½™å‰°', value: (surplus > 0 ? surplus : 0), fill: '#fbbf24' },
                { name: 'è»Šæ¤œç©ç«‹', value: savingsConfig.find(s => s.id === 'car')?.amount || 0, fill: '#94a3b8' },
                { name: 'NISA(æŠ•è³‡)', value: savingsConfig.find(s => s.id === 'nisa')?.amount || 0, fill: '#3b82f6' },
            ];
            
            const pieTotal = pieData.reduce((acc, item) => acc + item.value, 0);
            const activeBudgets = budgetConfig.filter(b => !b.oddMonthOnly || isOddMonth);
            
            // è³‡ç”£å¢—åŠ å†…è¨³
            const assetData = pieData.filter(d => d.value > 0);
            const totalAssetsCreated = totalSavingsPlanned + (surplus > 0 ? surplus : 0);

            return (
                <div className="space-y-6 pb-24 animate-fade-in">
                    <div className="flex bg-slate-100 p-1 rounded-lg">
                        {['portfolio', 'budget', 'bs'].map(tab => (
                            <button key={tab} onClick={() => setSubTab(tab)} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${subTab === tab ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`}>
                                {tab === 'portfolio' && 'è³‡ç”£æ§‹æˆ'}
                                {tab === 'budget' && 'äºˆç®—ç®¡ç†'}
                                {tab === 'bs' && 'è²¸å€Ÿå¯¾ç…§è¡¨'}
                            </button>
                        ))}
                    </div>

                    {subTab === 'portfolio' && (
                        <div className="space-y-4">
                            <Card className="p-4">
                                <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2 mb-4">
                                    <PieChart className="w-4 h-4 text-teal-600" /> ä»Šæœˆã®è³‡ç”£å†…è¨³ (ãƒ•ãƒ­ãƒ¼)
                                </h3>
                                {pieTotal > 0 ? (
                                    <>
                                        <div className="h-52 w-full flex justify-center">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <RePieChart>
                                                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={2} dataKey="value" stroke="none">
                                                        {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={entry.fill} />))}
                                                    </Pie>
                                                    <Tooltip formatter={(val) => `${val.toLocaleString()}å††`} contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                                                </RePieChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mt-2">
                                            {pieData.map((entry, i) => (
                                                <div key={i} className="flex items-center justify-between text-xs">
                                                    <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: entry.fill }}></div><span className="text-slate-600">{entry.name}</span></div>
                                                    <span className="font-bold text-slate-700">{Math.round((entry.value / pieTotal) * 100)}%</span>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-52 w-full flex items-center justify-center text-slate-400 text-sm">
                                        è³‡ç”£ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                    </div>
                                )}
                            </Card>

                            <Card className="p-4">
                                <h3 className="text-sm font-bold text-slate-700 flex items-center gap-2 mb-4">
                                    <BarChart3 className="w-4 h-4 text-blue-500" /> é•·æœŸè³‡ç”£æ¨ç§» (ç¾é‡‘ vs æŠ•è³‡)
                                </h3>
                                <div className="h-52 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={[...ASSET_HISTORY_DETAILED, { month: 'ç¾åœ¨', cash: totalCash, invest: totalInvest, total: currentTotalAssets }]} margin={{ top: 10, right: 0, left: -20, bottom: 0 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="month" axisLine={false} tickLine={false} tick={{fontSize: 10, fill: '#94a3b8'}} />
                                            <YAxis axisLine={false} tickLine={false} tick={{fontSize: 9, fill: '#94a3b8'}} tickFormatter={(val) => `${(val/10000).toFixed(0)}`} />
                                            <Tooltip formatter={(val) => `${(val/10000).toFixed(1)}ä¸‡å††`} contentStyle={{ borderRadius: '8px', border: 'none' }} />
                                            <Area type="monotone" dataKey="cash" stackId="1" stroke="#2dd4bf" fill="#2dd4bf" name="ç¾é‡‘" />
                                            <Area type="monotone" dataKey="invest" stackId="1" stroke="#3b82f6" fill="#3b82f6" name="æŠ•è³‡" />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </Card>

                            <div className="grid grid-cols-2 gap-3">
                                <Card className="p-3 bg-blue-50 border-blue-100">
                                    <div className="text-[10px] font-bold text-blue-600 mb-1 flex items-center gap-1"><Target className="w-3 h-3"/> NISA é‹ç”¨ç›Šç‡</div>
                                    <div className="text-xl font-extrabold text-slate-800">+11.8<span className="text-sm font-normal text-slate-500">%</span></div>
                                    <div className="text-[10px] text-slate-500 mt-1">å«ã¿ç›Š +6.0ä¸‡å††</div>
                                </Card>
                                <Card className="p-3 bg-teal-50 border-teal-100">
                                    <div className="text-[10px] font-bold text-teal-600 mb-1 flex items-center gap-1"><Percent className="w-3 h-3"/> ä»Šæœˆã®è²¯è“„ç‡</div>
                                    <div className="text-xl font-extrabold text-slate-800">
                                        {actualMonthlyIncome > 0 ? Math.round((totalAssetsCreated / actualMonthlyIncome) * 100) : 0}
                                        <span className="text-sm font-normal text-slate-500">%</span>
                                    </div>
                                    <div className="text-[10px] text-slate-500 mt-1">ç›®æ¨™30% / å®Ÿç¸¾</div>
                                </Card>
                            </div>
                        </div>
                    )}

                    {subTab === 'budget' && (
                        <div>
                            <div className="mb-3 text-center text-xs font-bold text-slate-500">
                                {selectedDate.getFullYear()}å¹´{selectedDate.getMonth() + 1}æœˆã®äºˆç®—
                            </div>
                            <Card className="divide-y divide-slate-100">
                                {activeBudgets.map(budget => {
                                    const current = categoryTotals[budget.name] || 0;
                                    const remaining = budget.amount - current;
                                    const isOver = remaining < 0;
                                    return (
                                        <div key={budget.id} className="p-4">
                                            <div className="flex justify-between items-end mb-2">
                                                <span className="font-bold text-slate-800 text-sm">{budget.name}</span>
                                                <span className={`font-bold text-sm ${isOver ? 'text-rose-500' : 'text-slate-500'}`}>{current.toLocaleString()} <span className="text-[10px] font-normal">/ {budget.amount.toLocaleString()}</span></span>
                                            </div>
                                            <ProgressBar current={current} max={budget.amount} colorClass={budget.type === 'fixed' ? 'bg-slate-400' : 'bg-teal-500'} />
                                            <div className="flex justify-between mt-1 text-[10px]">
                                                <span className="text-slate-400">{isOddMonth && budget.oddMonthOnly ? '(å¥‡æ•°æœˆè¨ˆä¸Š)' : ''}</span>
                                                <span className={`font-bold ${isOver ? 'text-rose-500' : 'text-teal-600'}`}>{isOver ? `Over ${Math.abs(remaining).toLocaleString()}` : `ã‚ã¨ ${remaining.toLocaleString()}`}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </Card>
                        </div>
                    )}
                    
                    {subTab === 'bs' && (
                        <div>
                            <div className="mb-3 text-center text-xs font-bold text-slate-500">
                                {selectedDate.getFullYear()}å¹´{selectedDate.getMonth() + 1}æœˆã®è²¸å€Ÿå¯¾ç…§è¡¨
                            </div>
                            <Card className="p-1 mb-4">
                                <div className="flex w-full min-h-[300px] gap-1">
                                    <div className="w-1/2 flex flex-col gap-1">
                                        <div className="bg-teal-50 p-2 text-center text-teal-800 font-bold text-xs rounded-t-lg">è³‡ç”£ã®å¢—åŠ </div>
                                        <div className="flex-1 flex flex-col gap-0.5 bg-slate-100 rounded-b-lg overflow-hidden p-1">
                                            {totalAssetsCreated > 0 ? (
                                                assetData.map((asset, idx) => (
                                                    <div key={idx} className="w-full flex items-center justify-center text-white text-[10px] font-bold shadow-sm" style={{ height: `${(asset.value / totalAssetsCreated) * 100}%`, backgroundColor: asset.fill, minHeight: '20px' }}>{asset.name}</div>
                                                ))
                                            ) : (
                                                <div className="flex-1 flex items-center justify-center text-slate-400 text-xs">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="w-1/2 flex flex-col gap-1">
                                        <div className="bg-blue-50 p-2 text-center text-blue-800 font-bold text-xs rounded-t-lg">ç´”åå…¥</div>
                                        <div className="flex-1 bg-blue-500 rounded-b-lg flex flex-col items-center justify-center text-white p-2">
                                            <div className="text-xl font-extrabold">+{totalAssetsCreated.toLocaleString()}</div>
                                            <div className="text-[10px]">å®¶è¨ˆé»’å­—é¡</div>
                                        </div>
                                    </div>
                                </div>
                            </Card>
                            <div className="grid grid-cols-2 gap-2 text-[10px] text-slate-500">
                                <div className="bg-white p-2 rounded border border-slate-100"><div className="font-bold mb-1">ç¢ºå®Ÿãªè²¯é‡‘</div>{savingsConfig.map(s => <div key={s.id} className="flex justify-between"><span>{s.name}</span><span>{s.amount/10000}ä¸‡</span></div>)}</div>
                                <div className="bg-white p-2 rounded border border-slate-100"><div className="font-bold mb-1">ä½™å‰°è³‡é‡‘</div><div className="flex justify-between"><span>åˆè¨ˆ</span><span>{(surplus/10000).toFixed(1)}ä¸‡</span></div></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SettingsView = ({
            contributions, setContributions, handleIncomeAdd, 
            selectedDate, handleCsvAdd, handleClearData,
            savingsConfig, setSavingsConfig,
            saveSettingsToCloud // Add this prop
        }) => {
            const [vpassStatus, setVpassStatus] = useState('idle');
            const [rakutenStatus, setRakutenStatus] = useState('idle');
            const [vpassCount, setVpassCount] = useState(0);
            const [rakutenCount, setRakutenCount] = useState(0);
            
            const vpassInputRef = useRef(null);
            const rakutenInputRef = useRef(null);

            // Debounce save for settings
            useEffect(() => {
                const timer = setTimeout(() => {
                    saveSettingsToCloud(contributions, savingsConfig);
                }, 1000);
                return () => clearTimeout(timer);
            }, [contributions, savingsConfig, saveSettingsToCloud]);

            // è²¯é‡‘è¨­å®šã®æ›´æ–°
            const updateSavings = (id, amountStr) => {
                const amount = Number(amountStr);
                setSavingsConfig(prev => prev.map(s => s.id === id ? { ...s, amount } : s));
            };

            // CSVè¡Œã‚’åˆ†å‰²ã™ã‚‹ï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
            const parseCSVLine = (line) => {
                const result = [];
                let startValue = 0;
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    if (line[i] === '"') inQuotes = !inQuotes;
                    else if (line[i] === ',' && !inQuotes) {
                        let val = line.substring(startValue, i).trim();
                        if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                        result.push(val);
                        startValue = i + 1;
                    }
                }
                let lastVal = line.substring(startValue).trim();
                if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.slice(1, -1);
                result.push(lastVal);
                return result;
            };

            const handleFileRead = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                const setStatus = type === 'SMBC' ? setVpassStatus : setRakutenStatus;
                const setCount = type === 'SMBC' ? setVpassCount : setRakutenCount;
                setStatus('processing');

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const text = event.target.result;
                        const lines = text.split(/\r\n|\n/);
                        const newTransactions = [];
                        
                        let dataStartIndex = 0;
                        
                        lines.forEach((line, index) => {
                            if (!line.trim()) return;
                            const cols = parseCSVLine(line);
                            
                            let date = '', title = '', amount = 0;

                            if (type === 'RAKUTEN') {
                                if (!cols[0].match(/^\d{4}/)) return;
                                date = cols[0].replace(/\//g, '.');
                                title = cols[1];
                                amount = -Math.abs(Number(cols[4])); 
                            } else if (type === 'SMBC') {
                                if (!cols[0].match(/^\d{4}/)) return;
                                date = cols[0].replace(/\//g, '.');
                                title = cols[1];
                                amount = -Math.abs(Number(cols[6]));
                            }

                            if (date && title && amount) {
                                newTransactions.push({
                                    id: Date.now() + index + Math.random(),
                                    date,
                                    title,
                                    category: 'æœªåˆ†é¡', 
                                    source: type,
                                    amount,
                                    type: 'expense',
                                    isShared: true
                                });
                            }
                        });

                        if (newTransactions.length > 0) {
                            handleCsvAdd(newTransactions);
                            setStatus('success');
                            setCount(newTransactions.length);
                        } else {
                            alert('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                            setStatus('idle');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        setStatus('idle');
                    }
                };
                reader.readAsText(file, 'Shift_JIS');
                e.target.value = '';
            };

            return (
                <div className="space-y-6 pb-24 animate-fade-in">
                    <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Settings className="w-5 h-5" /> è¨­å®š</h3>
                    
                    {/* CSV Upload Cards */}
                    <Card className="p-6 border-emerald-100 bg-emerald-50/30">
                        <div className="flex items-center gap-2 mb-4">
                            <div className="p-2 bg-emerald-100 rounded-full text-emerald-600"><FileText className="w-5 h-5" /></div>
                            <div><h4 className="font-bold text-slate-800">ä¸‰äº•ä½å‹ã‚«ãƒ¼ãƒ‰ (Vpass)</h4><p className="text-xs text-slate-500">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p></div>
                        </div>
                        <input type="file" ref={vpassInputRef} className="hidden" accept=".csv" onChange={(e) => handleFileRead(e, 'SMBC')} />
                        <div className={`border-2 border-dashed rounded-xl p-6 text-center transition-all cursor-pointer ${vpassStatus === 'success' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-300 hover:border-emerald-400 hover:bg-white'}`} onClick={() => vpassInputRef.current.click()}>
                            {vpassStatus === 'idle' && (<><UploadCloud className="w-8 h-8 text-slate-400 mx-auto mb-2" /><p className="text-sm font-bold text-slate-600">CSVã‚’é¸æŠ</p></>)}
                            {vpassStatus === 'processing' && (<div className="flex flex-col items-center"><RefreshCw className="w-8 h-8 text-emerald-500 animate-spin mb-2" /><p className="text-sm font-bold text-emerald-600">èª­ã¿è¾¼ã¿ä¸­...</p></div>)}
                            {vpassStatus === 'success' && (<div className="flex flex-col items-center"><CheckCircle2 className="w-8 h-8 text-emerald-500 mb-2" /><p className="text-sm font-bold text-emerald-600">å®Œäº†ï¼</p><p className="text-xs text-emerald-500">{vpassCount}ä»¶ã‚’è¿½åŠ </p></div>)}
                        </div>
                    </Card>

                    <Card className="p-6 border-rose-100 bg-rose-50/30">
                        <div className="flex items-center gap-2 mb-4">
                            <div className="p-2 bg-rose-100 rounded-full text-rose-600"><ShoppingBag className="w-5 h-5" /></div>
                            <div><h4 className="font-bold text-slate-800">æ¥½å¤©ã‚«ãƒ¼ãƒ‰ (e-NAVI)</h4><p className="text-xs text-slate-500">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p></div>
                        </div>
                        <input type="file" ref={rakutenInputRef} className="hidden" accept=".csv" onChange={(e) => handleFileRead(e, 'RAKUTEN')} />
                        <div className={`border-2 border-dashed rounded-xl p-6 text-center transition-all cursor-pointer ${rakutenStatus === 'success' ? 'border-rose-500 bg-rose-50' : 'border-slate-300 hover:border-rose-400 hover:bg-white'}`} onClick={() => rakutenInputRef.current.click()}>
                            {rakutenStatus === 'idle' && (<><UploadCloud className="w-8 h-8 text-slate-400 mx-auto mb-2" /><p className="text-sm font-bold text-slate-600">CSVã‚’é¸æŠ</p></>)}
                            {rakutenStatus === 'processing' && (<div className="flex flex-col items-center"><RefreshCw className="w-8 h-8 text-rose-500 animate-spin mb-2" /><p className="text-sm font-bold text-rose-600">èª­ã¿è¾¼ã¿ä¸­...</p></div>)}
                            {rakutenStatus === 'success' && (<div className="flex flex-col items-center"><CheckCircle2 className="w-8 h-8 text-rose-500 mb-2" /><p className="text-sm font-bold text-rose-600">å®Œäº†ï¼</p><p className="text-xs text-rose-500">{rakutenCount}ä»¶ã‚’è¿½åŠ </p></div>)}
                        </div>
                    </Card>

                    {/* åå…¥è¨­å®š */}
                    <Card className="p-6">
                        <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">åå…¥è¨­å®š (ç›®å®‰)</h4>
                        <div className="space-y-6">
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-bold text-slate-600 text-sm">å¤«ã®å…¥é‡‘é¡</span>
                                    <input type="number" value={contributions.husband} onChange={e => setContributions({...contributions, husband: Number(e.target.value)})} className="text-right bg-slate-50 p-2 rounded w-32 font-bold text-slate-800" />
                                </div>
                                <button onClick={() => handleIncomeAdd('husband', contributions.husband)} className="w-full py-2 bg-teal-50 text-teal-700 text-xs font-bold rounded-lg hover:bg-teal-100 transition-colors flex items-center justify-center gap-1">
                                    <Save className="w-3 h-3" /> {selectedDate.getMonth() + 1}æœˆã®åå…¥ã¨ã—ã¦ç™»éŒ²
                                </button>
                            </div>
                            
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-bold text-slate-600 text-sm">å¦»ã®å…¥é‡‘é¡</span>
                                    <input type="number" value={contributions.wife} onChange={e => setContributions({...contributions, wife: Number(e.target.value)})} className="text-right bg-slate-50 p-2 rounded w-32 font-bold text-slate-800" />
                                </div>
                                <button onClick={() => handleIncomeAdd('wife', contributions.wife)} className="w-full py-2 bg-teal-50 text-teal-700 text-xs font-bold rounded-lg hover:bg-teal-100 transition-colors flex items-center justify-center gap-1">
                                    <Save className="w-3 h-3" /> {selectedDate.getMonth() + 1}æœˆã®åå…¥ã¨ã—ã¦ç™»éŒ²
                                </button>
                            </div>
                            <p className="text-[10px] text-slate-400 mt-2">â€»æœˆã«ã‚ˆã£ã¦å…¥é‡‘é¡ãŒç•°ãªã‚‹å ´åˆã¯ã€é‡‘é¡ã‚’å¤‰æ›´ã—ã¦ã€Œç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </Card>

                    {/* å›ºå®šè²¯é‡‘è¨­å®š */}
                    <Card className="p-6">
                        <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">å›ºå®šè²¯é‡‘ãƒ»ç©ç«‹è¨­å®š (æœˆé¡)</h4>
                        <div className="space-y-4">
                            {savingsConfig.map(saving => (
                                <div key={saving.id} className="flex justify-between items-center border-b border-slate-100 pb-2">
                                    <span className="font-bold text-slate-600 text-sm">{saving.name}</span>
                                    <input 
                                        type="number" 
                                        value={saving.amount} 
                                        onChange={(e) => updateSavings(saving.id, e.target.value)} 
                                        className="text-right bg-slate-50 p-2 rounded w-32 font-bold text-slate-800" 
                                    />
                                </div>
                            ))}
                        </div>
                        <p className="text-[10px] text-slate-400 mt-2">â€»ã“ã“ã§è¨­å®šã—ãŸé‡‘é¡ã¯ã€è‡ªå‹•çš„ã«å®¶è¨ˆã®ä½™å‰°è³‡é‡‘è¨ˆç®—ã‹ã‚‰å·®ã—å¼•ã‹ã‚Œã¾ã™ã€‚</p>
                    </Card>

                    <Card className="p-6 border-slate-200 bg-slate-50">
                        <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                        <button onClick={handleClearData} className="w-full py-3 bg-white border border-slate-300 text-slate-600 text-xs font-bold rounded-lg hover:bg-rose-50 hover:text-rose-600 hover:border-rose-200 transition-colors flex items-center justify-center gap-2">
                            <Trash2 className="w-4 h-4" /> ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ã—ã¦åˆæœŸåŒ–
                        </button>
                    </Card>
                </div>
            );
        };

        const FamilyFinanceApp = () => {
            const [activeTab, setActiveTab] = useState('home'); 
            const [selectedDate, setSelectedDate] = useState(new Date('2026-01-01'));
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            // State
            const [contributions, setContributions] = useState({ husband: 220000, wife: 200000 });
            const [transactions, setTransactions] = useState([]);
            const [savingsConfig, setSavingsConfig] = useState(INITIAL_SAVINGS_CONFIG);
            const [budgetConfig, setBudgetConfig] = useState(INITIAL_BUDGET_CONFIG);
            
            const [user, setUser] = useState(null);
            const [isSaving, setIsSaving] = useState(false);

            // --- Firebase Auth & Firestore Listener ---
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;

                // Listen for Settings
                const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'settings');
                const unsubSettings = onSnapshot(settingsRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.contributions) setContributions(data.contributions);
                        if (data.savings) setSavingsConfig(data.savings);
                    }
                }, (err) => console.error("Settings sync error", err));

                // Listen for Transactions
                const txRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'transactions');
                const unsubTx = onSnapshot(txRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.list) setTransactions(data.list);
                    }
                }, (err) => console.error("Tx sync error", err));

                return () => {
                    unsubSettings();
                    unsubTx();
                };
            }, [user]);

            // --- Save Helpers ---
            const saveTransactionsToCloud = async (newTransactions) => {
                if (!user) return;
                setIsSaving(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'transactions'), {
                        list: newTransactions
                    });
                } catch (e) { console.error(e); }
                setIsSaving(false);
            };

            const saveSettingsToCloud = async (newContributions, newSavings) => {
                if (!user) return;
                setIsSaving(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'settings'), {
                        contributions: newContributions,
                        savings: newSavings
                    });
                } catch (e) { console.error(e); }
                setIsSaving(false);
            };

            const isOddMonth = (selectedDate.getMonth() + 1) % 2 !== 0;

            const currentMonthTransactions = useMemo(() => {
                return transactions.filter(t => {
                    const [year, month] = t.date.split('.').map(Number);
                    return year === selectedDate.getFullYear() && month === (selectedDate.getMonth() + 1);
                });
            }, [transactions, selectedDate]);

            const validTransactions = useMemo(() => currentMonthTransactions.filter(t => t.isShared), [currentMonthTransactions]);
            
            const categoryTotals = useMemo(() => {
                const totals = {};
                validTransactions.filter(t => t.type === 'expense').forEach(t => {
                totals[t.category] = (totals[t.category] || 0) + Math.abs(t.amount);
                });
                return totals;
            }, [validTransactions]);

            const monthlyIncomeTransactions = validTransactions.filter(t => t.type === 'income');
            const actualMonthlyIncome = monthlyIncomeTransactions.length > 0 
                ? monthlyIncomeTransactions.reduce((acc, t) => acc + t.amount, 0)
                : contributions.husband + contributions.wife;

            const currentTotalExpenses = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
            
            const totalSavingsPlanned = useMemo(() => savingsConfig.reduce((sum, s) => sum + s.amount, 0), [savingsConfig]);
            
            const surplus = actualMonthlyIncome - currentTotalExpenses - totalSavingsPlanned;

            const lastHistoryAsset = ASSET_HISTORY_DETAILED.length > 0 
                ? ASSET_HISTORY_DETAILED[ASSET_HISTORY_DETAILED.length - 1].total 
                : 0;
            
            const totalAccumulatedSurplus = useMemo(() => {
                return surplus > 0 ? surplus : 0;
            }, [surplus]);

            const currentTotalAssets = lastHistoryAsset + totalAccumulatedSurplus;
            const totalCash = Object.values(CURRENT_ASSETS_DETAIL.cash).reduce((a, b) => a + b, 0);
            const totalInvest = CURRENT_ASSETS_DETAIL.investment.nisa_principal + CURRENT_ASSETS_DETAIL.investment.nisa_profit;
            
            const firstHistoryAsset = ASSET_HISTORY_DETAILED.length > 0 ? ASSET_HISTORY_DETAILED[0].total : 0;
            const growthSinceStart = currentTotalAssets - firstHistoryAsset;

            const toggleShared = (id) => {
                const newTransactions = transactions.map(t => t.id === id ? { ...t, isShared: !t.isShared } : t);
                setTransactions(newTransactions); // Optimistic Update
                saveTransactionsToCloud(newTransactions);
            };

            const handleManualAdd = (data) => {
                const newTx = { id: Date.now(), ...data, type: 'expense', isShared: true };
                const newTransactions = [newTx, ...transactions];
                setTransactions(newTransactions);
                saveTransactionsToCloud(newTransactions);
            };
            
            const handleCsvAdd = (newTxList) => {
                const newTransactions = [...newTxList, ...transactions];
                setTransactions(newTransactions);
                saveTransactionsToCloud(newTransactions);
                alert(`${newTxList.length}ä»¶ã®æ˜ç´°ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
            };
            
            const handleIncomeAdd = (type, amount) => {
                const dateStr = selectedDate.toISOString().slice(0, 10).replace(/-/g, '.');
                const title = type === 'husband' ? 'å…±åŒå£åº§å…¥é‡‘ (å¤«)' : 'å…±åŒå£åº§å…¥é‡‘ (å¦»)';
                const newTx = {
                    id: Date.now(),
                    date: dateStr,
                    title: title,
                    category: 'å…¥é‡‘',
                    source: 'DIRECT',
                    amount: Number(amount),
                    type: 'income',
                    isShared: true
                };
                const newTransactions = [newTx, ...transactions];
                setTransactions(newTransactions);
                saveTransactionsToCloud(newTransactions);
                alert(`${selectedDate.getMonth() + 1}æœˆã®åå…¥ã¨ã—ã¦ ${amount.toLocaleString()}å†† ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
            };

            const handleClearData = () => {
                if(confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆå»ã•ã‚Œã¾ã™ã€‚')) {
                    setTransactions([]);
                    setContributions({ husband: 220000, wife: 200000 });
                    saveTransactionsToCloud([]);
                    saveSettingsToCloud({ husband: 220000, wife: 200000 }, INITIAL_SAVINGS_CONFIG);
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
                }
            };

            const updateTransaction = (id, field, value) => {
                const newTransactions = transactions.map(t => t.id === id ? { ...t, [field]: value } : t);
                setTransactions(newTransactions);
                saveTransactionsToCloud(newTransactions);
            };

            const deleteTransaction = (id) => {
                if (confirm('ã“ã®æ˜ç´°ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    const newTransactions = transactions.filter(t => t.id !== id);
                    setTransactions(newTransactions);
                    saveTransactionsToCloud(newTransactions);
                }
            };

            const handleGoToPortfolio = () => { setActiveTab('analysis'); };

            const changeMonth = (delta) => {
                const newDate = new Date(selectedDate);
                newDate.setMonth(newDate.getMonth() + delta);
                setSelectedDate(newDate);
            };

            return (
                <div className="min-h-screen bg-[#f0f9f6] font-sans text-slate-800 relative">
                    <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-3">
                        <div className="max-w-md mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-10 h-10 bg-white border-2 border-slate-800 rounded flex flex-col justify-center items-center shadow-[2px_2px_0px_0px_rgba(30,41,59,1)]">
                                    <span className="text-[10px] leading-none font-bold text-slate-800">å®¶æ—</span>
                                    <span className="text-[10px] leading-none font-bold text-slate-800">å®¶è¨ˆ</span>
                                </div>
                                <div><h1 className="text-base font-extrabold text-slate-800 leading-tight">å®¶æ—ã¾ã‚‹è¦‹ãˆ<br/>å®¶è¨ˆç°¿</h1></div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {user ? (
                                    <div className="flex items-center gap-1 text-[10px] bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full">
                                        <Cloud className="w-3 h-3" />
                                        <span>åŒæœŸä¸­</span>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-1 text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full">
                                        <CloudOff className="w-3 h-3" />
                                        <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
                                    </div>
                                )}
                                <div className="flex items-center bg-slate-100 rounded-full p-1">
                                    <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-white rounded-full transition-all"><ChevronLeft className="w-4 h-4 text-slate-500" /></button>
                                    <span className="text-xs font-bold px-2 text-slate-700 min-w-[80px] text-center">{selectedDate.getFullYear()}å¹´{selectedDate.getMonth() + 1}æœˆ</span>
                                    <button onClick={() => changeMonth(1)} className="p-1 hover:bg-white rounded-full transition-all"><ChevronRight className="w-4 h-4 text-slate-500" /></button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4">
                        {activeTab === 'home' && <HomeView 
                            selectedDate={selectedDate}
                            surplus={surplus}
                            currentTotalExpenses={currentTotalExpenses}
                            actualMonthlyIncome={actualMonthlyIncome}
                            totalSavingsPlanned={totalSavingsPlanned}
                            currentTotalAssets={currentTotalAssets}
                            growthSinceStart={growthSinceStart}
                            totalCash={totalCash}
                            totalInvest={totalInvest}
                            handleGoToPortfolio={handleGoToPortfolio}
                        />}
                        {activeTab === 'classify' && <ClassifyView 
                            currentMonthTransactions={currentMonthTransactions}
                            selectedDate={selectedDate}
                            toggleShared={toggleShared}
                            budgetConfig={budgetConfig}
                            updateTransaction={updateTransaction}
                            deleteTransaction={deleteTransaction}
                        />}
                        {activeTab === 'analysis' && <AnalysisView 
                            selectedDate={selectedDate}
                            budgetConfig={budgetConfig}
                            isOddMonth={isOddMonth}
                            categoryTotals={categoryTotals}
                            surplus={surplus}
                            totalSavingsPlanned={totalSavingsPlanned}
                            actualMonthlyIncome={actualMonthlyIncome}
                            totalCash={totalCash}
                            totalInvest={totalInvest}
                            currentTotalAssets={currentTotalAssets}
                            savingsConfig={savingsConfig}
                        />}
                        {activeTab === 'settings' && <SettingsView 
                            contributions={contributions}
                            setContributions={setContributions}
                            handleIncomeAdd={handleIncomeAdd}
                            selectedDate={selectedDate}
                            handleCsvAdd={handleCsvAdd}
                            handleClearData={handleClearData}
                            savingsConfig={savingsConfig}
                            setSavingsConfig={setSavingsConfig}
                            saveSettingsToCloud={saveSettingsToCloud}
                        />}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 pb-safe z-40">
                        <div className="max-w-md mx-auto grid grid-cols-4 h-16">
                            <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center justify-center gap-1 ${activeTab === 'home' ? 'text-teal-600' : 'text-slate-400'}`}><Landmark className="w-6 h-6" /><span className="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span></button>
                            <button onClick={() => setActiveTab('classify')} className={`flex flex-col items-center justify-center gap-1 ${activeTab === 'classify' ? 'text-teal-600' : 'text-slate-400'}`}><CreditCard className="w-6 h-6" /><span className="text-[10px] font-bold">ä»•åˆ†ã‘</span></button>
                            <button onClick={() => setActiveTab('analysis')} className={`flex flex-col items-center justify-center gap-1 ${activeTab === 'analysis' ? 'text-teal-600' : 'text-slate-400'}`}><PieChart className="w-6 h-6" /><span className="text-[10px] font-bold">åˆ†æ</span></button>
                            <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center justify-center gap-1 ${activeTab === 'settings' ? 'text-teal-600' : 'text-slate-400'}`}><Settings className="w-6 h-6" /><span className="text-[10px] font-bold">è¨­å®š</span></button>
                        </div>
                    </nav>
                    <div className="h-16" /> 

                    <div className="fixed bottom-24 right-6 z-50">
                        <button onClick={() => setIsModalOpen(true)} className="w-14 h-14 bg-slate-800 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-slate-700 transition-all active:scale-95"><Plus className="w-8 h-8" /></button>
                    </div>

                    <ManualInputModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleManualAdd} budgetConfig={budgetConfig} defaultDate={selectedDate} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<FamilyFinanceApp />);
    </script>
</body>
</html>
